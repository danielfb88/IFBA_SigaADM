<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
* Este arquivo é parte do programa SigaEPT
*
* O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
* termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
* na versão 2 da Licença.
*
* Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
* uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
* Pública Geral GNU/GPL em português para maiores detalhes.
*
* Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
* junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
* www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
* St, Fifth Floor, Boston, MA 02110-1301, USA
*/
?>
<?php
/**
 * @package SIGA
 * @subpackage Biblioteca
 * @author SETEC/MEC
 */

/*
 * @author Daniel bonfim
* Modificação em 29/03/2013
* Adicionado funcionalidade para devolução de multiplos exemplares.
*/
class frmDevolucao extends Form
{

	var $objEmprestimo;
	var $objDevolucao;
	var $objExemplar;
	var $objReserva;
	var $objReservar;

	function frmDevolucao()  // construtor da Classe
	{
		global $MIOLO,$module;

		// Título do Formulário
		$this->Form('Balcao de Emprestimos - Devoluçao');

		//Chama o CreateFileds, etc.
		$this->EventHandler();

		// Botão "enviar" não aparece
		$this->defaultButton = false;

	}


	function CreateFields() {


		// Campos que aparecem no formulário
		$fields = Array (
				//new Text('','Use o formulário abaixo para cadastrar uma nova usuarioobservacoes da biblioteca'),
					
				new HiddenField('hidID'),
				new HiddenField('hidKey'), // controla Incluir/Editar
				new TextField('edtExemplar','','Exemplar(es)',25),
				new Text('observacao','<font size=2 ><font color=red>Para devolver mais de um exemplar, separe-os com uma vírgula. Ex: 71, 23, 44</font>'),
				new HiddenField('hidIdEmprestimo'),
				new HiddenField('hidExemplar'),
				new HiddenField('hidIdusuarioopdevolucao'),
				new HiddenField('hidMulta'),
				new HiddenField('hidIdOperacao'),
		);

		// Insere os campos
		$this->SetFields($fields);


		// BotÃµes que aparecem no formulário
		$buttons = Array(
				new FormButton('btnDevolver', 'Confirmar Devoluçao'),
				new FormButton('btnConsulta', 'Consultar'),
				new FormButton('btnVoltar', 'Voltar'),

		);

		//Insere os Botões
		$this->SetButtons($buttons);


		// Atributo dos botões
		$this->SetButtonAttr('btnDevolver','visible',false);
		$this->SetButtonAttr('btnConsulta','visible',true);
		$this->SetButtonAttr('btnVoltar','visible',false);

		//Definindo o foco
		//$this->page->onLoad('document.'.$this->name.'.edtExemplar.focus();');
		$this->page->onLoad("MIOLO_GetElementById('edtExemplar').focus();");


		$this->AddValidator(new RequiredValidator('edtExemplar'));
			
	}

	// pega os dados que estão no formuláio
	function GetData()
	{
		$data = new FormData();
		$data->ID = $this->GetFieldValue('hidID');
		$data->exemplar = $this->GetFieldValue('edtExemplar');
		$data->idemprestimo = $this->GetFieldValue('hidIdEmprestimo');
		$data->hidexemplar = $this->GetFieldValue('hidExemplar');
		$data->hididopdevolucao = $this->GetFieldValue('hidIdusuarioopdevolucao');
		$data->hidmulta = $this->GetFieldValue('hidMulta');
		$data->hididoperacao = $this->GetFieldValue('hidIdOperacao');
		//var_dump($data);
		return $data;
	}


	// usada para inserir valores no formulário
	function SetData($data)
	{
		$this->SetFieldValue('hidID',$data->ID);
		$this->setFieldValue('edtExemplar',$data->exemplar);
		$this->setFieldValue('hidIdEmprestimo',$data->idemprestimo);
		$this->setFieldValue('hidExemplar',$data->hidexemplar);
		$this->setFieldValue('hidIdusuarioopdevolucao',$data->hididopdevolucao);
		$this->setFieldValue('hidMulta',$data->hidmulta);
		$this->setFieldValue('hidIdOperacao',$data->hididoperacao);
	}


	/**
	 * @author Daniel Bonfim
	 * @since 29-03-2013
	 */
	function btnConsulta_click() {
		global $MIOLO,$module,$item,$self, $theme, $page;

		$data = $this->GetData();

		$bussDevolucao = $MIOLO->GetBusiness($module,'devolucao');
		$bussEmprestimo = $MIOLO->GetBusiness($module,'emprestimo');
		$bussExemplar = $MIOLO->GetBusiness($module,'exemplar');

		$arrExemplares = explode(',', $data->exemplar);
		$arrExemplares = array_filter(array_unique($arrExemplares));
		sort($arrExemplares);
		// 		print_r($arrExemplares);die;

		if(count($arrExemplares) > 0) {
			$infoExemplares = $bussEmprestimo->getExemplaresEmprestadosByTombo($arrExemplares);
			$arrExemplaresNaoEncontrados = $arrExemplares;

			if(!is_null($infoExemplares)) {
				// Recuperar estas informações no método Devolver
				$_SESSION['infoExemplares'] = $infoExemplares;

				// Para cada exemplar encontrado
				for($i=0; $i<count($infoExemplares); $i++) {

					$numeroTombo = $infoExemplares[$i][3];
					$valorDaMulta = $infoExemplares[$i][5];
					$diasAtraso = $infoExemplares[$i][6];
					$obra = $infoExemplares[$i][9];
					$titulo  = $infoExemplares[$i][10];;
					$autor = $infoExemplares[$i][11];
					$edicao  = $infoExemplares[$i][12];
					$status = null;

					// guardando quais foram os exemplares não encontrados
					for($k=0; $k<count($arrExemplaresNaoEncontrados); $k++) {
						if($numeroTombo == $arrExemplaresNaoEncontrados[$k]) {
							unset($arrExemplaresNaoEncontrados[$k]);
						}
					}
					sort($arrExemplaresNaoEncontrados);


					if($diasAtraso > 0) {
						$valorDaMultaTotal = $diasAtraso * $valorDaMulta;
						$status = "<font color='red'><u> ATENÇÃO, devolução com MULTA: R$ $valorDaMultaTotal </u></font>";

					} else {
						$status = "<font color='blue'>OK Emprestado</font>";

					}

					$this->SetTitle('Detalhes do Exemplar');

					$this->AddField(new TextLabel('Exemplar', $numeroTombo, 'Exemplar'));
					$this->AddField(new TextLabel('Obra', $obra, 'Obra'));
					$this->AddField(new TextLabel('Titulo', $titulo, 'Titulo'));
					$this->AddField(new TextLabel('Autor', $autor, 'Autor'));
					$this->AddField(new TextLabel('Edicao', $edicao, 'Edicao'));
					$this->AddField(new TextLabel('Status', $status, 'Status'));
					$this->AddField(new MSeparator());
				}

				// Verificando se os exemplares não encontrados existem ou não estão emprestados
				for($k=0; $k<count($arrExemplaresNaoEncontrados); $k++) {
					if($bussExemplar->isExemplarExisteByTombo($arrExemplaresNaoEncontrados[$k])) {
						$status = "<font color='red'>O exemplar não está emprestado</font>";
					} else {
						$status = "<font color='red'>O exemplar não existe</font>";
					}

					$this->AddField(new TextLabel('Exemplar', $arrExemplaresNaoEncontrados[$k], 'Exemplar'));
					$this->AddField(new TextLabel('Status', $status, 'Status'));
					$this->AddField(new MSeparator());
				}


				// Atributo dos botões
				$this->SetButtonAttr('btnDevolver','visible',true);
				$this->SetButtonAttr('btnVoltar','visible',true);
				$this->SetButtonAttr('btnConsulta','visible',false);

				//Esconde os campos
				$this->SetFieldAttr('edtExemplar','visible', false);
				$this->SetFieldAttr('observacao','visible', false);

			} else {
				$go = $MIOLO->GetActionURL($module, $self);
				$MIOLO->Error("Exemplar(es) não emprestado(s) ou não existente(s).", $go);
			}
		}
	}


	/**
	 * TODO: Modificar para se enquadrar com a devolução multipla. Vou dormir.
	 */
	function btnDevolver_click()
	{
		global $MIOLO,$module,$item,$self, $theme, $action, $page;

		// Atributo dos botões
		$this->SetButtonAttr('btnDevolver','visible',false);
		$this->SetButtonAttr('btnvoltar','visible',true);
		$this->SetButtonAttr('btnConfirmar','visible',false);
		//Esconde os campos
		$this->SetFieldAttr('edtExemplar','visible', false);

		$this->objDevolucao = $MIOLO->GetBusiness($module,'devolucao');
		$this->objReserva = $MIOLO->GetBusiness($module,'reserva');
		$this->objReservar = $MIOLO->GetBusiness($module,'reservar');
		$this->objEmprestimo = $MIOLO->GetBusiness($module,'emprestimo');


		$data = $this->GetData();


		$this->objDevolucao->BeginTransaction();

		if (!$data->hidmulta)
		{

			/*
			 * Modificação em 13-03-2013
			* Substituído o método 'Devolucao' por 'devolverExemplar'
			*/
			if ( $dev == $this->objDevolucao->devolverExemplar($data->idemprestimo, $data->hidexemplar))
			{
				// LOG
				$log = $MIOLO->GetBusiness($module,'log');
				$log->SetData($this->getDataLog($data->idemprestimo));
				$log->save();

				$theme->ClearContent();
				// 				$MIOLO->Prompt(Prompt::Information("Devolução efetuada com SUCESSO",$MIOLO->GetActionURL($module,$self)));

				// Daniel Bonfim / 31-01-2013
				$msg = "Devolução efetuada com SUCESSO.</br> Deseja gerar o comprovante?";

				$gotoYes = $MIOLO->GetActionURL($module, $self, null, array('exemplar'=>$data->hidexemplar));
				$eventYes = 'imprimirRecibo';	// nome do método a ser executado

				$gotoNo = $MIOLO->GetActionURL($module, $self);
				$eventNo = '';

				$MIOLO->Question($msg, $gotoYes, $gotoNo, $eventYes, $eventNo);
			}
			else
			{
				$theme->ClearContent();
				$MIOLO->Prompt(Prompt::Error("Não foi possível concluir o processo de devolução",$MIOLO->GetActionURL($module,$self)));
			}


		}
		else
		{
			$devolucao = $this->objDevolucao->Devolucao($data);
			//  voltar  rever$multa = $this->objDevolucao->SetMulta($data);
			$logoperacao = $this->objDevolucao->SetLogOperacao($data);
			$theme->ClearContent();
			$multa = $data->hidmulta;
			$multa = str_replace(',','.',$multa);
			settype($multa,"float");
			//var_dump($multa);
			$MIOLO->Prompt(Prompt::Information("ATENÇÃO, a devolução gerou multa de R$" .number_format($multa,2,',',''),$MIOLO->GetActionURL($module,$self)));

		}

		$reserva = $this->objReserva->GetProximaReserva(0,$data->hidexemplar);
		//var_dump($reserva);
		//var_dump($data->hidexemplar);
			
		if ( $reserva )
		{
			$datalimite = $this->objReserva->CalculaData(1);
			$idsituacao = $this->objEmprestimo->GetSituacao('ATENDIDA')->result;
			//var_dump($idsituacao);
			$this->objReserva->ConfirmaReserva($reserva[0],$idsituacao[0][0],$datalimite);
			$mnemonico = 'RESERVADO';
			$query =$this->objReservar->GetEstado($mnemonico);
			$idestado = $query->result[0][0];
			$estado = $this->objDevolucao->SetEstado($idestado,$data->ID);
		}
		else
		{
			$mnemonico = 'DISPONIVEL';
			$query =$this->objReservar->GetEstado($mnemonico);
			$idestado = $query->result[0][0];
			$estado = $this->objDevolucao->SetEstado($idestado,$data->ID);


		}

		$this->objDevolucao->EndTransaction();

	}

	function getDataLog($Devolucao)
	{
		global $MIOLO;
		$data = new FormData();
		$data->data = date("d/m/Y H:i:s");
		$data->identificador = $Devolucao;
		$data->idusuario = $MIOLO->GetLogin()->idkey;
		$operacao = $MIOLO->GetBusiness('biblioteca','operacao');
		$operacao = $operacao->GetIdoperacaoByMnemonico('DEVOLUCAO');
		$data->idoperacao = $operacao->GetIdoperacao();
		return $data;
	}

	// Daniel Bonfim - 31-01-2013
	// Veja: http://trialforce.nostaljia.eng.br/?tag=thread-php
	function imprimirRecibo() {
		$parameters[ 'str_NUMERODOTOMBO' ] = Form::GetFormValue('exemplar');
		$report = new MJasperReport('sigaept');
		$report->Execute('biblioteca','Ticket1_Devolucao_UI', $parameters);
	}



}

?>
